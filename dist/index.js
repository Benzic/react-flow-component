!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("react")):"function"==typeof define&&define.amd?define(["react"],e):"object"==typeof exports?exports.laputarednerer=e(require("react")):t.laputarednerer=e(t.react)}(window,(function(t){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i(1);Object.defineProperty(e,"MultipleFlow",{enumerable:!0,get:function(){return n.default}})},function(t,e,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(t,e,i,n){void 0===n&&(n=i),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),o=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),l=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.hasOwnProperty.call(t,i)&&n(e,t,i);return o(e,t),e};Object.defineProperty(e,"__esModule",{value:!0});const s=l(i(2)),r=i(3);e.default=({flowNodes:t=[],rectConfig:e,lineCofig:i,onChange:n,onDBClick:o})=>{const l=s.useRef(null),c=s.useRef(null),d=s.useRef(null),u=s.useRef(!1);s.useEffect(()=>{d.current=new r.Flow(t,l.current,!0,e,i,n,o)},[e,i,t,n]);const h=s.useCallback(t=>{var i,n,o,l;const s=t.offsetX,r=t.offsetY;if(null!==d.current.activeMoveRect){const t=d.current.getRectIndex(d.current.activeMoveRect);u.current?(d.current.nodes[t].active&&(d.current.nodes[t].x=Math.floor(s/(null!==(i=null==e?void 0:e.xCorrecting)&&void 0!==i?i:10))*(null!==(n=null==e?void 0:e.xCorrecting)&&void 0!==n?n:10),d.current.nodes[t].y=Math.floor(r/(null!==(o=null==e?void 0:e.yCorrecting)&&void 0!==o?o:5))*(null!==(l=null==e?void 0:e.yCorrecting)&&void 0!==l?l:5)),d.current.initCanvas()):(d.current.initCanvas(),d.current.drawLine(d.current.nodes[t].x,d.current.nodes[t].y,s,r))}else d.current.activeDeleRect=null,d.current.initCanvas(),d.current.selectArea.startX=d.current.mouseDownXY.x,d.current.selectArea.startY=d.current.mouseDownXY.y,d.current.selectArea.endX=s,d.current.selectArea.endY=r,d.current.dragSelect(d.current.mouseDownXY.x,d.current.mouseDownXY.y,s,r)},[]),a=s.useCallback(()=>{l.current.onmousemove=h,l.current.onmouseup=function(t){const e=t.offsetX,i=t.offsetY;if(null===d.current.activeMoveRect||u.current)null===d.current.activeMoveRect&&d.current.findLineInCanvas();else{const t=d.current.findRectInCanvas(e,i),o=d.current.getRectIndex(d.current.activeMoveRect);t&&(d.current.nodes[o].toNodes=[...d.current.nodes[o].toNodes,t.key],d.current.nodes[o].active=!1,n&&n(d.current.nodes)),d.current.initCanvas()}d.current.activeMoveRect=null,l.current.onmousemove=null,l.current.onmouseup=null}},[h,n]),v=s.useCallback(t=>{const e=t.offsetX,i=t.offsetY;d.current.lastClickTime&&(u.current=!((new Date).valueOf()-d.current.lastClickTime.valueOf()<250)),d.current.lastClickTime=new Date,d.current.mouseDownXY.x=e,d.current.mouseDownXY.y=i;const o=d.current.findRectInCanvas(e,i);if(o){d.current.activeMoveRect=null==o?void 0:o.key,d.current.activeDeleRect=null==o?void 0:o.key,d.current.editLine=null,d.current.activeLines=[];const t=d.current.getRectIndex(null==o?void 0:o.key),e=d.current.nodes[t];d.current.nodes[t].active=!0,d.current.nodes.splice(t,1),d.current.nodes.push(e),n&&n(d.current.nodes),d.current.initCanvas()}a()},[a,n]);return s.useEffect(()=>{c.current&&(l.current.width=c.current.offsetWidth,l.current.height=c.current.offsetHeight,l.current.onmousedown=v)},[v]),s.default.createElement("div",{ref:c,style:{width:"100%",height:"100%"}},s.default.createElement("canvas",{ref:l,id:"canvas"}))}},function(e,i){e.exports=t},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(o,l){function s(t){try{c(n.next(t))}catch(t){l(t)}}function r(t){try{c(n.throw(t))}catch(t){l(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,r)}c((n=n.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.Flow=void 0;e.Flow=class{constructor(t,e,i,n,o,l,s){console.log(t,e,n,o,l,s),this.ctx=e.getContext("2d"),this.nodes=t,this.canvas=e,this.onChange=l,this.lineCfg=o,this.rectCfg=n,this.onDBClick=s,this.selectArea={startX:null,startY:null,endX:null,endY:null},this.doubleClickArea={x:null,y:null},this.isMutiple=i,this.activeLines=[],this.activeRects=[],this.editLine=null,this.activeMoveRect=null,this.mouseDownXY={x:null,y:null},s&&this.onListenDBClick(),this.initCanvas(),this.onListenKeyDown()}onListenKeyDown(){window.addEventListener("keydown",this.checkKeyDown.bind(this),!0)}onListenDBClick(){var t;(null===(t=this.rectCfg)||void 0===t?void 0:t.edit)&&window.addEventListener("mouseup",t=>{if((new Date).getTime()-this.lastMouseUpTime<250){const e=this.getRectIndex(this.activeMoveRect),i={node:this.nodes[e],index:e};this.doubleClickArea.x=t.offsetX,this.doubleClickArea.y=t.offsetY,this.findEditLine(),console.log(this.editLine,this.activeMoveRect),this.activeMoveRect&&this.onDBClick&&this.onDBClick(i),this.editLine&&(console.log("3333"),this.onDBClick&&this.onDBClick({type:"line",node:this.editLine}))}this.lastMouseUpTime=(new Date).getTime()},!0)}checkKeyDown(t){var e,i;46===t.keyCode&&((null===(e=this.activeLines)||void 0===e?void 0:e.length)&&this.deleLine(),(null===(i=this.activeRects)||void 0===i?void 0:i.length)&&this.deleRect(),this.initCanvas())}onCheckPosition(t,e){console.log(this.getRectIndex(this.activeMoveRect),this.activeMoveRect)}getRectIndex(t){var e;let i=0;const n=this.nodes;for(let o=0;o<=(null==n?void 0:n.length)-1;o++)if((null===(e=n[o])||void 0===e?void 0:e.key)===t)return i=o,i;return i}initCanvas(){var t,e,i,o,l,s,r,c,d,u,h;const a=this.nodes;if(this.ctx){this.ctx.clearRect(0,0,null===(t=this.canvas)||void 0===t?void 0:t.width,null===(e=this.canvas)||void 0===e?void 0:e.height);for(let t=0;t<=(null==a?void 0:a.length)-1;t++)for(let e=0;e<=(null===(i=a[t].toNodes)||void 0===i?void 0:i.length)-1;e++){const i=a[this.getRectIndex(a[t].toNodes[e])];if(i){const o=a[t],l=this.activeLines.find(t=>t.fromNodes===o.key&&t.toNodes===o.toNodes[e]);let s=!1;this.editLine&&(s=this.editLine.fromNodes===o.key&&this.editLine.toNodes===o.toNodes[e]),l?(()=>{n(this,void 0,void 0,(function*(){yield setTimeout(()=>{},0),this.drawLine(o.x,o.y,i.x,i.y,l,s),this.dragTriangle(o.y,i.x,i.y,l,s)}))})():(this.drawLine(o.x,o.y,i.x,i.y,l),this.dragTriangle(o.y,i.x,i.y,l))}}for(let t=0;t<=(null==a?void 0:a.length)-1;t++){const e=a[t],i=null!==(o=e.corner)&&void 0!==o?o:null===(l=this.rectCfg)||void 0===l?void 0:l.corner,n=null===(s=this.rectCfg)||void 0===s?void 0:s.width,v=null===(r=this.rectCfg)||void 0===r?void 0:r.height,f=this.activeMoveRect===e.key,g=null!==(c=e.bgImg)&&void 0!==c?c:null===(d=this.rectCfg)||void 0===d?void 0:d.bgImg,x=null===(u=this.rectCfg)||void 0===u?void 0:u.bgColor,C=null===(h=this.rectCfg)||void 0===h?void 0:h.activeBgColor;this.drawRoundedRect(e.x,e.y,i,e.title,f,g,n,v,x,C)}}}deleLine(){var t,e;const i=this.nodes,n=this.activeLines;for(let o=0;o<=(null==n?void 0:n.length)-1;o++){const l=this.getRectIndex(null===(t=n[o])||void 0===t?void 0:t.key);i[l]&&(i[l].toNodes=null===(e=i[l])||void 0===e?void 0:e.toNodes.filter(t=>t!==n[o].toNodes))}console.log(n,i),this.onChange&&this.onChange(i),this.activeLines=[]}deleRect(){var t,e;const i=this.nodes;for(let n=0;n<=(null==i?void 0:i.length)-1;n++)for(let o=0;o<=(null===(e=null===(t=i[n])||void 0===t?void 0:t.toNodes)||void 0===e?void 0:e.length)-1;o++)i[n].toNodes[o]===this.activeRects&&(i[n].toNodes=i[n].toNodes.splice(this.getRectIndex(this.activeRects),1));const n=this.getRectIndex(this.activeRects);i.splice(n,1),this.onChange&&this.onChange(i),this.activeRects=null}findRectInCanvas(t,e){var i,n,o,l;let s=null;const r=this.nodes,c=(null===(i=this.rectCfg)||void 0===i?void 0:i.width)/2||50,d=(null===(n=this.rectCfg)||void 0===n?void 0:n.height)/2||15;for(let i=0;i<=(null==r?void 0:r.length)-1;i++){const n=r[i].corner?r[i].corner:null!==(l=null===(o=this.rectCfg)||void 0===o?void 0:o.corner)&&void 0!==l?l:0,u=Math.sqrt(Math.pow(r[i].x-t,2)+Math.pow(r[i].y-e,2)),h=Math.sqrt(Math.pow(c-n,2)+Math.pow(d-n,2))+n;if(t<r[i].x+c&&t>r[i].x-c&&e<r[i].y+d&&e>r[i].y-d&&u<h&&r[i].key!==this.activeMoveRect){s={point:r[i],key:r[i].key};break}}return s}findLeftRightLine(t,e,i){const{startY:n,endY:o,endX:l,startX:s}=this.selectArea,r=t<l&&t>s;if(e>i){if(e>o&&i<n)return r&&!0}else if(i>o&&e<n)return r&&!0;return(e>n&&e<o||i>n&&i<o)&&r&&!0}findCenterLine(t,e,i){const{startY:n,endY:o,endX:l,startX:s}=this.selectArea,r=e<o&&e>n;return t>s&&t<l||i>s&&i<l?r&&!0:(t<s&&i>s||i>l&&t<l)&&r&&!0}findEditLine(){var t;this.editLine=null;const{x:e,y:i}=this.doubleClickArea;for(let n=0;n<=(null===(t=this.activeLines)||void 0===t?void 0:t.length)-1;n++){let t=this.activeLines[n].x,o=this.activeLines[n].y;e>t-20&&e<t+20&&i>o-5&&i<o+5&&(this.editLine=this.activeLines[n])}}findLineInCanvas(){var t,e,i;let n=null;const o=this.nodes;this.activeLines=[];for(let i=0;i<=(null==o?void 0:o.length)-1;i++)for(let l=0;l<=(null===(t=o[i].toNodes)||void 0===t?void 0:t.length)-1;l++){const t=o[i].x,s=o[i].y,r=this.getRectIndex(o[i].toNodes[l]),c=o[r].x,d=o[r].y;let u,h,a,v;const f=(null===(e=this.rectCfg)||void 0===e?void 0:e.height)/2||15;if(u=s>d&&s>d+f+30||s<d&&s<d-f-30?s<d?s+Math.abs((s-d)/2):d+Math.abs((s-d)/2):s<d?s-30-f:s+30,t<c?(h=this.findLeftRightLine(t,s,u),v=this.findCenterLine(t,u,c),a=this.findLeftRightLine(c,d,u)):(h=this.findLeftRightLine(c,d,u),v=this.findCenterLine(c,u,t),a=this.findLeftRightLine(t,s,u)),h||v||a){let e=t<c?t+(c-t)/2:c+(t-c)/2;n={fromNodes:o[i].key,toNodes:o[i].toNodes[l],x:e,y:u},n&&this.activeLines.push(n)}}(null===(i=this.activeLines)||void 0===i?void 0:i.length)&&(this.activeMoveRect=null),this.initCanvas()}drawText(t,e,i,n){var o,l,s,r,c,d,u,h,a,v,f,g,x,C;this.ctx.fillStyle=null!==(l=null===(o=this.rectCfg)||void 0===o?void 0:o.txtColor)&&void 0!==l?l:"black",this.ctx.font=(null===(s=this.rectCfg)||void 0===s?void 0:s.fontSize)?(null===(r=this.rectCfg)||void 0===r?void 0:r.fontSize)+" Arial":"12px Arial";const y=null!==(d=null===(c=this.rectCfg)||void 0===c?void 0:c.align)&&void 0!==d?d:"center";let w,p;const R=this.ctx.measureText(i).width,m=(null!==(h=null===(u=this.rectCfg)||void 0===u?void 0:u.corner)&&void 0!==h?h:5)<5?5:null!==(v=null===(a=this.rectCfg)||void 0===a?void 0:a.corner)&&void 0!==v?v:5;"center"===y?(w=t-R/2,p=e+5):"left"===y?(w=t-(null===(f=this.rectCfg)||void 0===f?void 0:f.width)/2+m,p=e+5):"right"===y&&(w=t+((null===(g=this.rectCfg)||void 0===g?void 0:g.width)/2-R)-m,p=e+5),n&&(this.ctx.fillStyle=null!==(C=null===(x=this.rectCfg)||void 0===x?void 0:x.activeTxtColor)&&void 0!==C?C:"white"),this.ctx.fillText(i,w,p)}drawLine(t,e,i,n,o,l){var s,r,c,d,u,h,a;const v=(null===(s=this.rectCfg)||void 0===s?void 0:s.height)/2||15;this.ctx.save(),this.ctx.beginPath(),e>n&&e>n+v+30||e<n&&e<n-v-30?(e>n?this.ctx.moveTo(t,e-v):this.ctx.moveTo(t,e+v),this.ctx.lineTo(t,e+(n-e)/2),this.ctx.lineTo(i,e+(n-e)/2)):(e>n?this.ctx.moveTo(t,e+v):this.ctx.moveTo(t,e-v),this.ctx.lineTo(t,e+(e>n?30:-30)),this.ctx.lineTo(i,e+(e>n?30:-30))),e>n?this.ctx.lineTo(i,n+v):this.ctx.lineTo(i,n-v),this.ctx.lineWidth=null!==(c=null===(r=this.lineCfg)||void 0===r?void 0:r.width)&&void 0!==c?c:2,this.ctx.strokeStyle=null!==(u=null===(d=this.lineCfg)||void 0===d?void 0:d.color)&&void 0!==u?u:"#40a9ff",o&&(this.ctx.strokeStyle=null!==(a=null===(h=this.lineCfg)||void 0===h?void 0:h.activeColor)&&void 0!==a?a:"orange"),l&&(this.ctx.strokeStyle="red"),this.ctx.stroke(),this.ctx.restore(),o&&this.drawLineRect(t,e,i,n)}dragTriangle(t,e,i,n,o){var l,s,r,c,d,u,h,a,v;const f=(null===(l=this.rectCfg)||void 0===l?void 0:l.height)/2||15,g=2.5*(null!==(r=null===(s=this.lineCfg)||void 0===s?void 0:s.width)&&void 0!==r?r:2),x=Math.sqrt(Math.pow(2*g,2)-Math.pow(g,2));this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=null!==(d=null===(c=this.lineCfg)||void 0===c?void 0:c.color)&&void 0!==d?d:"#40a9ff",n&&(this.ctx.fillStyle=null!==(h=null===(u=this.lineCfg)||void 0===u?void 0:u.activeColor)&&void 0!==h?h:"orange"),o&&(this.ctx.strokeStyle="red"),this.ctx.moveTo(e,i-(t-i>0?-f:f)),this.ctx.lineTo(e-g,i-(t-i>0?-f-x:f+x)),this.ctx.lineTo(e+g,i-(t-i>0?-f-x:f+x)),this.ctx.lineTo(e,i-(t-i>0?-f:f)),this.ctx.lineWidth=null!==(v=null===(a=this.lineCfg)||void 0===a?void 0:a.width)&&void 0!==v?v:2,this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}drawLineRect(t,e,i,n){const o=t>i?i+Math.abs((t-i)/2):t+Math.abs((t-i)/2);let l=null;l=e>n&&e>n+5+30||e<n&&e<n-5-30?e+(n-e)/2:e+(e>n?30:-30),this.drawRoundedRect(o,l,3,"编辑线",!1,"",20,5)}drawRoundedRect(t,e,i,n,o,l,s,r,c,d){const u=null!=i?i:0,h=null!=s?s:50,a=null!=r?r:15;this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t-h+u,e-a),this.ctx.lineTo(t+h-u,e-a),this.ctx.arcTo(t+h,e-a,t+h,e+u,u),this.ctx.lineTo(t+h,e+a-u),this.ctx.arcTo(t+h,e+a,t+h-u,e+a,u),this.ctx.lineTo(t-h+u,e+a),this.ctx.arcTo(t-h,e+a,t-h,e+a-u,u),this.ctx.lineTo(t-h,e-a+u),this.ctx.arcTo(t-h,e-a,t-h+u,e-a,u),this.ctx.fillStyle=null!=c?c:"white",o&&(this.ctx.fillStyle=null!=d?d:"#40a9ff"),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore(),l?this.drawImage(l,t,e,n,o):n&&this.drawText(t,e,n,o)}drawImage(t,e,i,n,o){var l,s,r,c,d,u;const h=(null===(l=this.rectCfg)||void 0===l?void 0:l.width)/2||50,a=(null===(s=this.rectCfg)||void 0===s?void 0:s.height)/2||15,v=new Image;v.src=t,this.ctx.drawImage(v,e-h,i-a,null!==(c=null===(r=this.rectCfg)||void 0===r?void 0:r.width)&&void 0!==c?c:50,null!==(u=null===(d=this.rectCfg)||void 0===d?void 0:d.height)&&void 0!==u?u:30),n&&this.drawText(e,i,n,o)}dragSelect(t,e,i,n){this.ctx.save(),this.ctx.beginPath(),this.ctx.setLineDash([8,8]),this.ctx.moveTo(t,e),this.ctx.lineTo(i,e),this.ctx.lineTo(i,n),this.ctx.lineTo(t,n),this.ctx.lineTo(t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#999",this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()}}}])}));